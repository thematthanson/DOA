<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transition System Integration Test</title>
    <style>
        body {
            font-family: 'SF Mono', monospace;
            background: #000;
            color: #00ff41;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #111;
            border: 2px solid #00ff41;
            border-radius: 8px;
            padding: 20px;
        }

        .test-section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }

        .test-button {
            background: #00ff41;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'SF Mono', monospace;
            font-weight: bold;
            margin: 5px;
        }

        .log-panel {
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-size: 11px;
        }

        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }

        .log-entry.info { color: #00ff41; }
        .log-entry.warn { color: #ffaa00; }
        .log-entry.error { color: #ff4444; }
        .log-entry.test { color: #00aaff; }
        .log-entry.integration { color: #ff00ff; }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .status-panel {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
        }

        .iframe-container {
            border: 1px solid #333;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        iframe {
            width: 100%;
            height: 400px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Transition System Integration Test</h1>
        <p>Testing integration between transition system and main application</p>

        <!-- Test Controls -->
        <div class="test-section">
            <h3>Integration Tests</h3>
            <button class="test-button" onclick="testTransitionSystemLoad()">Test Transition System Load</button>
            <button class="test-button" onclick="testMainAppLoad()">Test Main App Load</button>
            <button class="test-button" onclick="testIntegration()">Test Full Integration</button>
            <button class="test-button" onclick="clearLog()">Clear Log</button>
        </div>

        <!-- Status Display -->
        <div class="status-grid">
            <div class="status-panel">
                <h3>Transition System Status</h3>
                <div id="transition-status">
                    <p>Status: <span id="ts-status">Not Loaded</span></p>
                    <p>Version: <span id="ts-version">Unknown</span></p>
                    <p>Tests: <span id="ts-tests">Not Run</span></p>
                </div>
            </div>

            <div class="status-panel">
                <h3>Main App Status</h3>
                <div id="main-app-status">
                    <p>Status: <span id="ma-status">Not Loaded</span></p>
                    <p>Version: <span id="ma-version">Unknown</span></p>
                    <p>Integration: <span id="ma-integration">Not Tested</span></p>
                </div>
            </div>
        </div>

        <!-- Test Log -->
        <div class="test-section">
            <h3>Integration Test Log</h3>
            <div class="log-panel" id="log-panel">
                <div class="log-entry info">Integration test environment ready.</div>
            </div>
        </div>

        <!-- Main App Preview -->
        <div class="test-section">
            <h3>Main Application Preview</h3>
            <div class="iframe-container">
                <iframe id="main-app-frame" src="index.html"></iframe>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let transitionSystemLoaded = false;
        let mainAppLoaded = false;
        let integrationTested = false;

        // Logging function
        function log(message, type = 'info') {
            const logPanel = document.getElementById('log-panel');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logPanel.appendChild(logEntry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        // Clear log
        function clearLog() {
            document.getElementById('log-panel').innerHTML = '';
            log('Log cleared.');
        }

        // Update status displays
        function updateStatus() {
            document.getElementById('ts-status').textContent = transitionSystemLoaded ? 'Loaded' : 'Not Loaded';
            document.getElementById('ts-version').textContent = transitionSystemLoaded ? '1.0.0' : 'Unknown';
            document.getElementById('ts-tests').textContent = transitionSystemLoaded ? 'Ready' : 'Not Run';

            document.getElementById('ma-status').textContent = mainAppLoaded ? 'Loaded' : 'Not Loaded';
            document.getElementById('ma-version').textContent = mainAppLoaded ? 'Current' : 'Unknown';
            document.getElementById('ma-integration').textContent = integrationTested ? 'Tested' : 'Not Tested';
        }

        // Test transition system loading
        async function testTransitionSystemLoad() {
            log('=== TESTING TRANSITION SYSTEM LOAD ===', 'test');
            
            try {
                // Load transition system script
                const script = document.createElement('script');
                script.src = 'transition-system.js';
                script.onload = () => {
                    log('Transition system script loaded successfully', 'info');
                    
                    // Test if classes are available
                    if (typeof window.TransitionSystem !== 'undefined') {
                        log('✓ TransitionSystem class available', 'test');
                        transitionSystemLoaded = true;
                        
                        // Run unit tests
                        if (typeof window.createTransitionSystemTestSuite !== 'undefined') {
                            log('Running transition system unit tests...', 'test');
                            const testSuite = window.createTransitionSystemTestSuite();
                            testSuite.runTests().then(() => {
                                log('✓ Transition system unit tests completed', 'test');
                                updateStatus();
                            });
                        }
                    } else {
                        log('✗ TransitionSystem class not found', 'error');
                    }
                };
                script.onerror = () => {
                    log('✗ Failed to load transition-system.js', 'error');
                };
                document.head.appendChild(script);
                
            } catch (error) {
                log(`✗ Transition system load test failed: ${error.message}`, 'error');
            }
        }

        // Test main app loading
        function testMainAppLoad() {
            log('=== TESTING MAIN APP LOAD ===', 'test');
            
            try {
                const iframe = document.getElementById('main-app-frame');
                
                iframe.onload = () => {
                    log('Main app iframe loaded successfully', 'info');
                    mainAppLoaded = true;
                    
                    // Try to access main app content
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (iframeDoc) {
                            log('✓ Main app document accessible', 'test');
                            
                            // Check for key elements
                            const hasContent = iframeDoc.body && iframeDoc.body.innerHTML.length > 0;
                            if (hasContent) {
                                log('✓ Main app has content', 'test');
                            } else {
                                log('⚠ Main app appears empty', 'warn');
                            }
                        }
                    } catch (e) {
                        log('⚠ Cannot access main app content (CORS restriction)', 'warn');
                    }
                    
                    updateStatus();
                };
                
                iframe.onerror = () => {
                    log('✗ Failed to load main app', 'error');
                };
                
            } catch (error) {
                log(`✗ Main app load test failed: ${error.message}`, 'error');
            }
        }

        // Test full integration
        async function testIntegration() {
            log('=== TESTING FULL INTEGRATION ===', 'integration');
            
            if (!transitionSystemLoaded) {
                log('✗ Transition system not loaded. Run transition system test first.', 'error');
                return;
            }
            
            if (!mainAppLoaded) {
                log('✗ Main app not loaded. Run main app test first.', 'error');
                return;
            }
            
            try {
                // Test integration scenarios
                log('Testing integration scenarios...', 'integration');
                
                // Scenario 1: Create transition system instance
                const system = new window.TransitionSystem();
                log('✓ Transition system instance created', 'integration');
                
                // Scenario 2: Initialize with test show
                const testShow = { title: 'Integration Test Show', duration: 120, id: 'integration-test' };
                system.initialize(testShow);
                log('✓ Transition system initialized with test show', 'integration');
                
                // Scenario 3: Test UI callbacks
                let callbackReceived = false;
                const uiCallbacks = {
                    onStateChange: (state) => {
                        callbackReceived = true;
                        log('✓ UI callback received: state change', 'integration');
                    }
                };
                
                system.initialize(testShow, { uiCallbacks });
                if (callbackReceived) {
                    log('✓ UI callback system working', 'integration');
                }
                
                // Scenario 4: Test session management
                system.updateSessionTime(90 * 60); // 90 minutes
                system.updateIndexingProgress(60);
                
                const receipt = system.getSessionReceipt();
                if (receipt && receipt.numberOfShows > 0) {
                    log('✓ Session receipt generation working', 'integration');
                }
                
                log('=== INTEGRATION TEST COMPLETED ===', 'integration');
                integrationTested = true;
                updateStatus();
                
            } catch (error) {
                log(`✗ Integration test failed: ${error.message}`, 'error');
            }
        }

        // Initialize test environment
        document.addEventListener('DOMContentLoaded', function() {
            log('Integration test environment initialized', 'info');
            log('Ready to test transition system integration', 'info');
            updateStatus();
        });

        // Auto-run basic tests on load
        window.addEventListener('load', function() {
            setTimeout(() => {
                log('Auto-running basic tests...', 'info');
                testTransitionSystemLoad();
                testMainAppLoad();
            }, 1000);
        });

        // Expose transition system debug/test functions globally
        window.initializeTransitionSystem = initializeTransitionSystem;
        window.debugTransitionSystem = debugTransitionSystem;
        window.startIndexingWithTransitionSystem = startIndexingWithTransitionSystem;
        window.transitionToShowWithSystem = transitionToShowWithSystem;
        window.completeSessionWithTransitionSystem = completeSessionWithTransitionSystem;

        initializeTransitionSystem();
        debugTransitionSystem();
    </script>
</body>
</html> 