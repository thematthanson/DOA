<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Fix - Genre Channel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .emergency-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .emergency-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .emergency-section h3 {
            margin-top: 0;
            color: #333;
        }
        
        .status-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-info { background: #17a2b8; color: white; }
        
        button:hover {
            opacity: 0.8;
        }
        
        .iframe-container {
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        iframe {
            width: 100%;
            height: 500px;
            border: none;
        }
        
        .log-container {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            height: 150px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="emergency-container">
        <h1>üö® Emergency Fix - Genre Channel</h1>
        <p>This page disables all problematic features to stop infinite loops and crashes.</p>
        
        <div class="emergency-section">
            <h3>üö® Emergency Controls</h3>
            <div class="status-display" id="statusDisplay">
                Loading status...
            </div>
            <div class="controls">
                <button class="btn-danger" onclick="disableAllFeatures()">üö® Disable All Features</button>
                <button class="btn-success" onclick="enableBasicFeatures()">‚úÖ Enable Basic Features</button>
                <button class="btn-warning" onclick="resetSystem()">üîÑ Reset System</button>
                <button class="btn-info" onclick="refreshStatus()">üìä Refresh Status</button>
            </div>
        </div>
        
        <div class="emergency-section">
            <h3>üì∫ Genre Channel (Safe Mode)</h3>
            <div class="iframe-container">
                <iframe id="genreChannelFrame" src="Genre-channel_v2.html"></iframe>
            </div>
            <div class="controls">
                <button class="btn-success" onclick="loadSafeContent()">üì∫ Load Safe Content</button>
                <button class="btn-warning" onclick="testBasicFunctionality()">üß™ Test Basic Functionality</button>
            </div>
        </div>
        
        <div class="emergency-section">
            <h3>üìù Emergency Logs</h3>
            <div class="log-container" id="logContainer">
                <div>üö® Emergency Fix initialized...</div>
            </div>
        </div>
    </div>

    <script>
        let frameWindow;
        let logContainer;
        let statusDisplay;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            logContainer = document.getElementById('logContainer');
            statusDisplay = document.getElementById('statusDisplay');
            
            // Wait for iframe to load
            const iframe = document.getElementById('genreChannelFrame');
            iframe.onload = () => {
                frameWindow = iframe.contentWindow;
                log('‚úÖ Genre Channel iframe loaded');
                disableAllFeatures(); // Auto-disable on load
                refreshStatus();
            };
            
            log('üö® Emergency Fix initialized');
        });
        
        // Logging function
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // Disable all problematic features
        function disableAllFeatures() {
            if (!frameWindow) {
                log('‚ùå Frame not available');
                return;
            }
            
            log('üö® Disabling all problematic features...');
            
            // Disable overlap fix
            if (frameWindow.genreChannelOverlapFix) {
                frameWindow.genreChannelOverlapFix.disable();
                frameWindow.genreChannelOverlapFix.autoFillGaps = false;
                frameWindow.genreChannelOverlapFix.isEnabled = false;
                log('‚úÖ Overlap fix disabled');
            }
            
            // Disable overlap detector
            if (frameWindow.overlapDetector) {
                frameWindow.overlapDetector.disable();
                frameWindow.overlapDetector.isEnabled = false;
                log('‚úÖ Overlap detector disabled');
            }
            
            // Disable change monitor
            if (frameWindow.changeMonitor) {
                frameWindow.changeMonitor.disable();
                frameWindow.changeMonitor.isEnabled = false;
                log('‚úÖ Change monitor disabled');
            }
            
            // Restore original width calculation
            if (frameWindow.calculateWidth && frameWindow.calculateWidth._overridden) {
                // Restore original function if possible
                frameWindow.calculateWidth = function(duration) {
                    return (duration / (frameWindow.currentTimelineDuration || 240)) * 100;
                };
                log('‚úÖ Original width calculation restored');
            }
            
            log('üö® All features disabled - system should be stable');
            refreshStatus();
        }
        
        // Enable only basic features
        function enableBasicFeatures() {
            if (!frameWindow) {
                log('‚ùå Frame not available');
                return;
            }
            
            log('‚úÖ Enabling basic features only...');
            
            // Enable only overlap fix without gap filling
            if (frameWindow.genreChannelOverlapFix) {
                frameWindow.genreChannelOverlapFix.autoFillGaps = false;
                frameWindow.genreChannelOverlapFix.enable();
                log('‚úÖ Basic overlap fix enabled (no gap filling)');
            }
            
            log('‚úÖ Basic features enabled');
            refreshStatus();
        }
        
        // Reset the system
        function resetSystem() {
            if (!frameWindow) {
                log('‚ùå Frame not available');
                return;
            }
            
            log('üîÑ Resetting system...');
            
            // Reload the iframe
            const iframe = document.getElementById('genreChannelFrame');
            iframe.src = iframe.src;
            
            log('üîÑ System reset complete');
        }
        
        // Refresh status
        function refreshStatus() {
            if (!frameWindow) {
                statusDisplay.innerHTML = '‚ùå Frame not available';
                return;
            }
            
            let status = '<strong>Emergency Status:</strong><br>';
            
            // Check overlap fix
            if (frameWindow.genreChannelOverlapFix) {
                const overlapStatus = frameWindow.genreChannelOverlapFix.getStatus();
                status += `üîß Overlap Fix: ${overlapStatus.isEnabled ? 'ENABLED' : 'DISABLED'}<br>`;
                status += `üîÑ Auto Gap Filling: ${overlapStatus.autoFillGaps ? 'ENABLED' : 'DISABLED'}<br>`;
            } else {
                status += `üîß Overlap Fix: NOT FOUND<br>`;
            }
            
            // Check overlap detector
            if (frameWindow.overlapDetector) {
                status += `üîç Overlap Detector: ${frameWindow.overlapDetector.isEnabled ? 'ENABLED' : 'DISABLED'}<br>`;
            } else {
                status += `üîç Overlap Detector: NOT FOUND<br>`;
            }
            
            // Check change monitor
            if (frameWindow.changeMonitor) {
                status += `üìä Change Monitor: ${frameWindow.changeMonitor.isEnabled ? 'ENABLED' : 'DISABLED'}<br>`;
            } else {
                status += `üìä Change Monitor: NOT FOUND<br>`;
            }
            
            statusDisplay.innerHTML = status;
            log('üìä Status refreshed');
        }
        
        // Load safe content
        function loadSafeContent() {
            if (!frameWindow) return;
            
            log('üì∫ Loading safe content...');
            
            // Load minimal, safe content
            const safeContent = [
                { title: 'Safe Content 1', duration: 60, genre: 'Comedy' },
                { title: 'Safe Content 2', duration: 90, genre: 'Drama' }
            ];
            
            if (frameWindow.loadTestContent) {
                frameWindow.loadTestContent(safeContent);
                log('‚úÖ Safe content loaded');
            } else {
                log('‚ùå loadTestContent function not available');
            }
        }
        
        // Test basic functionality
        function testBasicFunctionality() {
            if (!frameWindow) return;
            
            log('üß™ Testing basic functionality...');
            
            // Test if basic functions work
            const blocks = frameWindow.document.querySelectorAll('.program-slot:not(.empty)');
            log(`üì¶ Found ${blocks.length} blocks`);
            
            if (blocks.length > 0) {
                log('‚úÖ Basic functionality working');
            } else {
                log('‚ö†Ô∏è No blocks found - may need to load content');
            }
        }
        
        // Auto-refresh status every 10 seconds
        setInterval(() => {
            if (frameWindow) {
                refreshStatus();
            }
        }, 10000);
    </script>
</body>
</html> 